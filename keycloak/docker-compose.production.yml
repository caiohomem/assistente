services:
  nginx:
    image: nginx:alpine
    container_name: keycloak-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - keycloak
    restart: unless-stopped
    networks:
      - keycloak-network

  keycloak:
    # Substitua 'caiohb77' pelo seu username do Docker Hub
    # Para versão específica: caiohb77/keycloak-custom:1.0
    # Para latest: caiohb77/keycloak-custom:latest
    image: caiohb77/keycloak-custom:1.0
    container_name: keycloak
    environment:
      # Provisionamento automático do admin (Keycloak 26.0+)
      # O admin é criado automaticamente na primeira inicialização
      KC_BOOTSTRAP_ADMIN_USERNAME: admin
      KC_BOOTSTRAP_ADMIN_PASSWORD: admin

      # Database configuration - Neon PostgreSQL
      # Connection String: postgresql://neondb_owner:npg_dcn6oJIReT0Z@ep-spring-star-abbjctg7-pooler.eu-west-2.aws.neon.tech/neondb?sslmode=require&channel_binding=require
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://ep-spring-star-abbjctg7-pooler.eu-west-2.aws.neon.tech:5432/neondb?sslmode=require&channel_binding=require
      KC_DB_USERNAME: neondb_owner
      KC_DB_PASSWORD: npg_dcn6oJIReT0Z

      # Hostname and proxy configuration
      # Configurado para usar domínio com proxy reverso (Cloudflare + nginx)
      KC_HOSTNAME: "keycloak.callback-local-cchagas.xyz"
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_HTTP_ENABLED: "true"
      KC_HTTPS_PORT: "443"
      KC_PROXY_HEADERS: "xforwarded"
      KC_PROXY: "edge"
      # Cloudflare usa HTTPS, então o Keycloak deve saber que está atrás de proxy HTTPS
      KC_PROXY_ADDRESS_FORWARDING: "true"
      # Força o Keycloak a gerar URLs HTTPS mesmo recebendo HTTP do nginx
      KC_HTTP_RELATIVE_PATH: "/"
      # Configurações adicionais de proxy
      KC_PROXY_PROTOCOL_ENABLED: "false"
      
    ports:
      - "8080:8080"
    volumes:
      - ./start-keycloak.sh:/start-keycloak.sh:ro
      # Volume para importação de realms (opcional)
      # Coloque arquivos .json no diretório ./realm-import/ para importação automática
      - ./realm-import:/opt/keycloak/data/import:ro
    entrypoint: ["/bin/bash", "/start-keycloak.sh"]
    restart: unless-stopped
    networks:
      - keycloak-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

networks:
  keycloak-network:
    driver: bridge

